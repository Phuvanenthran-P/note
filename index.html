<!doctype html>
if(reg && reg.showNotification){
reg.showNotification(note.title||'Pinned note', {body: note.body, tag: 'pinned-note-'+note.id, requireInteraction: true, data:{id:note.id}});
} else {
// fallback: Notification from page
if(Notification.permission==='granted'){
new Notification(note.title||'Pinned note',{body:note.body,tag:'pinned-note-'+note.id,requireInteraction:true,data:{id:note.id}});
}
}
}catch(e){console.warn(e)}
}
}


async function unpinNotification(note){
// Ask service worker to close notifications with this tag and clear pinned flag
if('serviceWorker' in navigator && navigator.serviceWorker.controller){
navigator.serviceWorker.controller.postMessage({type:'UNPIN_NOTE',id:note.id});
}
// Also attempt to close notifications from page
if('getNotifications' in ServiceWorkerRegistration.prototype){
const regs = await navigator.serviceWorker.getRegistration();
if(regs){
const notifs = await regs.getNotifications({tag:'pinned-note-'+note.id});
notifs.forEach(n=>n.close());
}
}
// update storage
note.pinned = false;
await putNote(note);
}


// --- request permission and register SW ---
async function init(){
if('serviceWorker' in navigator){
try{
const reg = await navigator.serviceWorker.register('/sw.js');
console.log('sw registered',reg);
}catch(e){console.warn('sw reg failed',e)}
}
if('Notification' in window){
if(Notification.permission === 'default'){
try{ await Notification.requestPermission(); }catch(e){}
}
}
await refreshNotes();
// try to show pinned notes (in case service worker didn't on its own)
const all = await getAllNotes();
for(const n of all){ if(n.pinned) sendPinRequestToSW(n); }
}
init();


// Listen for messages from SW (e.g. when notification clicked or removed)
navigator.serviceWorker && navigator.serviceWorker.addEventListener('message', async (ev)=>{
const data = ev.data || {};
if(data.type === 'NOTIF_CLICK'){ /* could open UI or focus */ }
if(data.type === 'NOTIF_CLOSED'){ /* could sync state */ }
// refresh notes in case pin state changed
await refreshNotes();
});


</script>
</body>
</html>
